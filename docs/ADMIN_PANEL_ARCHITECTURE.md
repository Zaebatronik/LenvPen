# Архитектура Админ-панели

## 🎯 Назначение

Админ-панель для управления пользователями, просмотра статистики и модерации контента приложения «Лень-в-Пень».

---

## 🏗 Технологический стек

- **Frontend**: Next.js 14 (App Router)
- **UI**: shadcn/ui + Tailwind CSS
- **Backend**: Supabase (PostgreSQL + Auth)
- **Деплой**: Vercel

---

## 👥 Роли и доступы

### Admin (Администратор)
- ✅ Полный доступ ко всем данным
- ✅ Назначение/удаление ролей
- ✅ Редактирование пользователей
- ✅ Удаление пользователей
- ✅ Экспорт данных

### Moderator (Модератор)
- ✅ Просмотр всех данных
- ✅ Просмотр статистики
- ❌ Редактирование данных
- ❌ Управление ролями

### User (Пользователь)
- ✅ Только свои данные
- ❌ Доступ к админ-панели

---

## 📊 Структура страниц

### 1. Dashboard (`/admin`)
**Главная страница с общей статистикой**

#### Метрики:
- Общее количество пользователей
- Активные пользователи (за последние 7 дней)
- Неактивные пользователи (>30 дней без отчётов)
- Средняя "Победа над собой" (%)
- Общее количество отчётов
- Отчётов за сегодня

#### Графики:
- Регистрации по дням (30 дней)
- Активность по дням
- Топ-5 зависимостей

#### Недавние действия:
- Последние 10 регистраций
- Последние 10 отчётов

---

### 2. Пользователи (`/admin/users`)
**Список всех пользователей с фильтрацией**

#### Фильтры:
- Поиск по username, telegram_id
- Фильтр по стране
- Фильтр по статусу (работаю/учусь/не работаю)
- Фильтр по профессии
- Активность (активные/неактивные)
- Диапазон процента победы (0-100%)

#### Таблица:
| Поле | Описание |
|------|----------|
| Avatar | Фото профиля |
| Username | @username |
| Telegram ID | ID пользователя |
| Имя | Имя и фамилия |
| Страна | Страна |
| Профессия | Должность |
| Победа | % победы |
| Отчётов | Количество |
| Регистрация | Дата |
| Последний вход | Дата |
| Действия | Кнопки |

#### Действия:
- Открыть профиль
- Экспортировать данные
- (Админ) Удалить пользователя

---

### 3. Профиль пользователя (`/admin/users/[id]`)
**Детальная карточка пользователя**

#### Блоки:

##### Общая информация
- Telegram ID
- Username
- Имя, фамилия
- Страна, город
- Статус (работаю/учусь)
- Должность
- Дата регистрации
- Последний вход

##### Главная цель
- Текст цели
- Категория (зависимость/лайф-цель/дисциплина)
- График оценок (0-10) за последние 30 дней
- Средняя оценка

##### Зависимости
Список карточек:
- Иконка + название
- Прогресс (%)
- Streak (дни подряд)
- Приоритет (1-10)
- Уточнения (meta)
- График прогресса за 30 дней

##### Дневные отчёты
Таблица с фильтрацией:
- Дата
- Шаг к цели (да/нет)
- Оценка дня (0-10)
- Зависимости (сводка)
- Настроение (стресс/сон/энергия)

График активности (календарь):
- Зелёный = отчёт заполнен
- Красный = пропущен

##### Статистика
- Всего отчётов
- Подряд дней с отчётами
- Средняя оценка дня
- Самая проблемная зависимость
- Самая успешная зависимость

---

### 4. Зависимости (общая статистика) (`/admin/dependencies`)
**Анализ популярности зависимостей**

#### Таблица:
| Зависимость | Пользователей | Средний % | Avg Streak | Успешных |
|-------------|---------------|-----------|------------|----------|
| Курение | 150 | 42% | 7 дней | 25% |
| Телефон | 320 | 38% | 5 дней | 18% |
| Алкоголь | 80 | 55% | 12 дней | 40% |

#### Графики:
- Распределение по популярности
- Средний прогресс по каждой зависимости
- Корреляция зависимостей (какие часто идут вместе)

---

### 5. Отчёты (`/admin/reports`)
**Все дневные отчёты**

#### Фильтры:
- Диапазон дат
- Пользователь (поиск)
- Оценка дня (0-10)
- Наличие срывов

#### Таблица:
- Дата
- Пользователь
- Оценка
- Шаг к цели
- Сводка зависимостей
- Настроение

---

### 6. Роли (`/admin/roles`)
**Управление ролями (только для админов)**

#### Таблица:
- Пользователь
- Роль (Admin/Moderator)
- Назначена (дата)
- Кем назначена

#### Действия:
- Назначить роль
- Удалить роль

---

## 🔌 API Endpoints для админки

### Статистика
```
GET /api/admin/stats
```
Возвращает общую статистику для Dashboard.

### Пользователи
```
GET /api/admin/users
  ?search=username
  &country=Russia
  &status=full_time
  &active=true
  &page=1
  &limit=50
```

```
GET /api/admin/users/[id]
```

```
DELETE /api/admin/users/[id]  (только admin)
```

### Зависимости
```
GET /api/admin/dependencies/stats
```

### Отчёты
```
GET /api/admin/reports
  ?user_id=uuid
  &from=2025-01-01
  &to=2025-12-31
  &page=1
```

### Роли
```
GET /api/admin/roles
```

```
POST /api/admin/roles
{
  "user_id": "uuid",
  "role": "admin" | "moderator"
}
```

```
DELETE /api/admin/roles/[user_id]
```

---

## 🎨 UI Компоненты (shadcn/ui)

### Используемые компоненты:
- `DataTable` — таблицы с сортировкой и пагинацией
- `Card` — карточки метрик
- `Chart` — графики (recharts)
- `Badge` — бейджи статусов
- `Dialog` — модальные окна
- `Select` — фильтры
- `Input` — поиск
- `Button` — действия
- `Tabs` — вкладки на странице профиля

---

## 🔐 Безопасность

### Авторизация
```typescript
// middleware.ts
export async function middleware(req: NextRequest) {
  const supabase = createMiddlewareClient({ req, res });
  const { data: { session } } = await supabase.auth.getSession();
  
  if (!session) {
    return NextResponse.redirect('/login');
  }
  
  // Проверка роли
  const { data: role } = await supabase
    .from('admin_roles')
    .select('role')
    .eq('user_id', session.user.id)
    .single();
    
  if (!role) {
    return NextResponse.redirect('/unauthorized');
  }
  
  return NextResponse.next();
}

export const config = {
  matcher: '/admin/:path*'
};
```

### RLS в Supabase
- Все запросы используют `service_role_key` на backend
- Проверка роли через функции `is_admin()` и `is_moderator_or_admin()`
- User видит только свои данные
- Admin/Moderator видят всё через расширенные политики

---

## 📦 Структура проекта админки

```
admin-panel/
├── app/
│   ├── (auth)/
│   │   ├── login/
│   │   └── layout.tsx
│   ├── admin/
│   │   ├── layout.tsx          # Layout с навигацией
│   │   ├── page.tsx            # Dashboard
│   │   ├── users/
│   │   │   ├── page.tsx        # Список пользователей
│   │   │   └── [id]/
│   │   │       └── page.tsx    # Профиль пользователя
│   │   ├── dependencies/
│   │   │   └── page.tsx        # Статистика зависимостей
│   │   ├── reports/
│   │   │   └── page.tsx        # Список отчётов
│   │   └── roles/
│   │       └── page.tsx        # Управление ролями
│   └── api/
│       └── admin/
│           ├── stats/
│           ├── users/
│           ├── dependencies/
│           ├── reports/
│           └── roles/
├── components/
│   ├── ui/                     # shadcn/ui компоненты
│   ├── admin/
│   │   ├── Navbar.tsx
│   │   ├── StatCard.tsx
│   │   ├── UserTable.tsx
│   │   ├── DependencyCard.tsx
│   │   └── ReportCalendar.tsx
├── lib/
│   ├── supabase.ts
│   └── utils.ts
└── middleware.ts
```

---

## 🚀 Roadmap разработки

### Фаза 1: MVP (2-3 недели)
- ✅ Dashboard с основной статистикой
- ✅ Список пользователей с поиском
- ✅ Профиль пользователя (базовый)
- ✅ Авторизация через Supabase

### Фаза 2: Расширенная (1-2 недели)
- ✅ Графики и аналитика
- ✅ Управление ролями
- ✅ Экспорт данных
- ✅ Фильтры и сортировка

### Фаза 3: Продвинутая (будущее)
- 🔄 Real-time уведомления
- 🔄 Массовые действия
- 🔄 Кастомные отчёты
- 🔄 Интеграция с аналитикой

---

## 🎯 Примеры UI

### Dashboard
```
┌─────────────────────────────────────────────────┐
│  📊 Статистика                                   │
├─────────────────────────────────────────────────┤
│  👥 Пользователи    📝 Отчётов      💪 Средняя   │
│      1,234           5,678          победа 42%  │
│                                                  │
│  📈 Регистрации (30 дней)  📊 Топ зависимостей │
│  [График]                  1. Телефон (320)     │
│                            2. Курение (150)     │
│                            3. Алкоголь (80)     │
└─────────────────────────────────────────────────┘
```

### Профиль пользователя
```
┌─────────────────────────────────────────────────┐
│  @username  🇷🇺  Программист                    │
│  ID: 123456789  Зарег: 01.11.2025               │
├─────────────────────────────────────────────────┤
│  🎯 Цель: Получить повышение                    │
│  📊 Средняя оценка: 7.5/10                      │
├─────────────────────────────────────────────────┤
│  🎭 Зависимости                                 │
│  🚬 Курение          [████████░░] 42%  🔥 7 дней│
│  📱 Телефон          [██████░░░░] 38%  🔥 3 дня │
├─────────────────────────────────────────────────┤
│  📝 Отчёты (календарь)                          │
│  [Календарь с отметками]                        │
└─────────────────────────────────────────────────┘
```

---

Эта архитектура готова к реализации и масштабированию! 🚀
